Manifest-db
=======

Stores all the manifests and corresponding image-infos to test OSbuild.

# Introduction

![](https://mermaid.ink/svg/pako:eNo9j70OwjAMhF_F8kxfoAMTDJXoAiPpYBqnWGoclDpCCPHuhN_NJ393p7vjmDxji2FO1_FM2WC3d9odu0gTg-cgKiZJB2iaiRUiqQRerGnW0B_7rxqc9hWAtJyKzB5e3y5-Q0RDGnCFkXMk8bXs7hTAoZ05ssO2nrWIymwOnT4qWi6ejLdeLGVsA80Lr5CKpcNNR2wtF_5BG6EpU_xT_Db1n1XvcY8nBzNOUA)

## Image definitions

Image definitions are the Way we describe an image and do exist for every image
we support. Definitions can be found in
[osbuild-composer/internal/distros](https://github.com/osbuild/osbuild-composer/tree/main/internal/distro)

### Image definitions must be tested

- We need to run OSBuild against every one of them
- Check the build is *correct*
    - Absence of accidental change
    - Validate changes on a rare occasion

OSBuild can't run the image definition directly.
It needs an intermediate format, the
[manifest](https://github.com/osbuild/manifest-db/blob/main/manifest-db/centos_8-aarch64-ami-boot.json#L8)

## Manifests

The Manifest is a JSON representation of an image definition. It tells OSBuild
what to do to make an Image

## Image info

The [Image info](https://github.com/osbuild/manifest-db/blob/main/manifest-db/centos_8-aarch64-ami-boot.json#L6868) is a JSON representation of an image

Generated by the tool
[`image-info`](https://github.com/osbuild/manifest-db/blob/main/tools/image-info)
it contains a list of discoverable pieces of information such as:
- Package list
- Network configuration
- ...

## Test cases

Combination of manifest and image-info. They are the reference point of what is
`correct` for a given input. They must be generated and stored for later use

## Test cases generation

### Manifests

With a stable version of Composer, a manifest is
[generated](https://github.com/osbuild/osbuild-composer/tree/main/cmd/gen-manifests)
for each image definition
- Easy to run, consume few
[resources](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L58)

### Image info

With a stable version of OSBuild

* Generate an image for each manifest
* Generate an image info for each image

Generation is a [heavy duty
task](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L75):

- Requires a machine per `arch+distro`
- And up to
[2h10](https://gitlab.com/redhat/services/products/image-builder/ci/manifest-db/-/jobs/3119412435) to build a set of manifests on a machine


# The way we did before Manifest-DB

### Generation is manual

#### Meaning

- in depth knowledge of our toolchain is required
- access to internal network for rhel distributions
- access to specialized hardware (ppc)

As a result, its not accessible especially for external developers
(that prevents them from contributing to image definitions)

### The tests and their cases are stored on Composer

As their main purpose is to test the non regression of OSBuild (using
[image_test](https://github.com/osbuild/osbuild-composer/blob/main/test/cases/image_tests.sh))
they should not belong in Composer

# With the Manifest-DB repository

### Automation

#### Updating the DB, CI job

- [Generates the manifests](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L68)
- [Runs OSBuild on
them](https://github.com/osbuild/manifest-db/blob/main/test/cases/manifest_tests#L27)
- [Generates the image
info](https://github.com/osbuild/manifest-db/blob/main/tools/osbuild-image-test#L274)
and [updates the DB](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml#L117)
- [Sends](https://github.com/osbuild/manifest-db/blob/main/schutzbot/include_image_info.sh#L33)
a [PR](https://github.com/osbuild/manifest-db/pull/55) (tooling for
reviewers [`tools/update_tool`](https://github.com/osbuild/manifest-db/pull/42))

Note: you can add yourself to the [list of reviewers](https://github.com/osbuild/manifest-db/blob/main/schutzbot/include_image_info.sh#L37) if you want to get notified

#### Keeping toolchain up to date

- [GH action](https://github.com/osbuild/manifest-db/blob/main/.github/workflows/propagate_to_osbuild.yml) to update OSBuild's reference commit
- [GH action](https://github.com/osbuild/osbuild/blob/main/.github/workflows/propagate_to_manifestdb.yml) to update Manifest-DB's reference commit

### The tests and their cases are stored on Manifest-DB

- test in [`tools/osbuild-image-test`](https://github.com/osbuild/manifest-db/tree/main/tools/osbuild-image-test)
- data in the [`manifest-db`](https://github.com/osbuild/manifest-db/tree/main/manifest-db) directory

# Update workflow

#### 1/ on GitHub: trigger the Gitlab CI

Using a GitLab `trigger token` the GitHub action starts the CI with a
different workflow than the one used to run the regression testing.

#### 2/ on CI: Manifest generation

The first job downloads the latest osbuild-composer sources from upstream,
generates all test manifests using the gen-manifest tool and stores them as an
artifact.

#### 3/ on CI: Image-info builds

Then a job for each architecture and distribution listed in
[.gitlab-ci.yml](https://github.com/osbuild/manifest-db/blob/main/.gitlab-ci.yml)
will run in parallel. Each job will:

- import the generated manifests.
- generate and include the image-info for the manifests where possible and
  expose them as artifacts.

#### 4/ on CI: PR creation

Finally the last job imports the generated manifests and image-info, updates the
DB with these information, creates a branch, a commit, pushes it on Github and
finally opens a PR using the [Schutzbot](https://github.com/schutzbot) user.

The PR message contains a check list of changed manifests and image-info. The
list is generated with the command `tool/update_tool report --github-markdown`.

#### Resuming in a diagram

```mermaid
flowchart TD
    subgraph Gitlab
        GH0[(Repo)]
        GH01[Pipeline]
        GH01 --> GH1
        GH1 -.- GH0
        GH2 -.- GH0
        GH3 -.- GH0
        GH1{3. Generate manifests}
        GH01 --> GH2{4. Build all image-info}
        GH01 --> GH3{5. Create $BRANCH\n create update commit\npush $BRANCH}
    end
    subgraph Github/Manifest-db
        RS0[ 2. Action\n\nTrigger pipeline\non branch main ]
        RSO1[ 7. Action\n\n Propagate main's\nSHA on OSBuild]
        GH4[(Repo)]
    end
    subgraph Github/OSBuild
        OS0[(Repo)]
    end
    RS0 --> GH01    
    i((Scheduler)) -- 1. start github action--> RS0
    GH3 == open PR ===> GH4
    j{{Maintainer}} -.6. review to\nmerge/discard\nPR .-> GH4
    j -..8. review to\nmerge/discard\nPR ..-> OS0

    RSO1 == open PR ==> OS0
    GH4 ---|upon\nupdate\non main| RSO1
```


### Contributing

Please refer to the [developer guide](https://www.osbuild.org/guides/developer-guide/developer-guide.html) to learn about our workflow, code style and more.

### License:

 - **Apache-2.0**
 - See LICENSE file for details.
